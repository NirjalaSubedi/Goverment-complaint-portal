<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="style/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" type="img/png" href="./logo.png">
    <style>
        .bg-none{
            background-color:#f5f5f5;
        }
        .Quick-actions{
            border-bottom: none;
        }
        /* Notifications UI */
        #notifications-icon {
            position: relative;
            cursor: pointer;
            font-size: 26px;
            color: #0d55e7;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 8px;
            border-radius: 50%;
            background: rgba(13, 85, 231, 0.08);
            z-index: 1001;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        #notifications-icon:hover { background: rgba(13,85,231,.15); transform: scale(1.05); }
        .notification-badge { position:absolute; top:-6px; right:-6px; background:#dc2626; color:#fff; width:20px; height:20px; border-radius:50%; display:none; align-items:center; justify-content:center; font-size:12px; font-weight:700; }
        .notification-dropdown { position:absolute; top:50px; right:0; background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); width:350px; max-height:400px; overflow-y:auto; display:none; z-index:1000; }
        .notification-dropdown.show { display:block; }
        .notification-header { padding:12px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; font-weight:600; }
        .mark-all-read { padding:6px 10px; border:none; background:#f0f0f0; color:#0d55e7; border-radius:6px; cursor:pointer; font-size:12px; }
        .notification-item { padding:12px 16px; border-bottom:1px solid #f5f5f5; cursor:pointer; }
        .notification-item.unread { background:#e3f2fd; }
        .notification-item:hover { background:#f8f9fa; }
        .notification-item-message { font-size:14px; color:#333; margin-bottom:4px; }
        .notification-item-time { font-size:12px; color:#999; }
        .notification-empty { padding:24px 16px; text-align:center; color:#999; }
    </style>
</head>
<body>
    <script>
        function populateUserInfo() {
            fetch('../backend/getuser.php', { credentials: 'include' })
                .then((response) => response.json())
                .then((data) => {
                    if (data.error) return;

                    const roleEl = document.querySelector('.role');
                    const nameEl = document.querySelector('.username');
                    const backLink = document.querySelector('.backButton');
                    const backText = backLink ? backLink.querySelector('span') : null;

                    if (nameEl && data.fullName) nameEl.textContent = data.fullName;
                    if (roleEl && data.userType) roleEl.textContent = data.userType;

                    if (backLink && data.userType) {
                        if (data.userType === 'Officer') {
                            backLink.setAttribute('href', 'officerdasboard.html');
                        } else {
                            backLink.setAttribute('href', 'citizendashboard.html');
                        }
                        
                    }
                })
                .catch((error) => console.error('Error fetching user info:', error));
        }

        document.addEventListener('DOMContentLoaded', populateUserInfo);
        </script>
    <header>
        <div class="container" style="min-height:60px">
            <div class="sub-container">
                <div class="logo">
                <img src="images/logo.png" alt="logo">
                </div>
                <div class="title">
                <h1 class="Heading1" id="Heading1">Nikaas</h1>
                </div>
            </div>
            <div class="auth-buttons">
                <button id="language-toggle" onclick="toggleLanguage()">
                    <i class="material-icons">language</i> नेपाली
                </button>
               <div style="position: relative;">
                    <i class="material-icons" id="notifications-icon">notifications</i>
                    <div class="notification-badge" id="notification-badge">0</div>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-header">
                            <span id="notification-header-text">Notifications</span>
                            <button class="mark-all-read" id="mark-all-read-btn">Mark all as read</button>
                        </div>
                        <div id="notification-list"></div>
                    </div>
               </div>
                <div class="profile-sections">
                    <i class="material-icons" id="profile-icon">account_circle</i>
                    <div class="user-type">
                    <div class="username">UserName</div>
                    <div class="role">Citizen</div>
                    </div>
                </div>
               </div>
            </div>
    </header>

<div class="main-divider">
    <div class="dashboard-container">
        <div class="backButtonContainer">
            <a href="citizendashboard.html" class="backButton">
                <i class="material-icons">arrow_back</i>
                <span>Back to Dashboard</span>
            </a>
        </div>
        
        <div class="registrationDetails securitySettings">
            <div class="profile123">
                <p class="profileDesc"> Security Settings</p>
                    <i class="material-icons profileIcon" style="color:rgb(200, 0, 0);">security</i>
            </div>
            <div class="settingsContainer">
                <div class="settingItem">
                    <div class="settingInfo">
                        <p class="settingTitle">Change Password</p>
                        <p class="settingDesc">Update your account password</p>
                    </div>
                        <button type="button" class="settingBtn changePasswordBtn" id="changePasswordBtn" onclick="window.location.href='password/changepassword.html'">Change</button>
                </div>
                <div class="settingItem">
                    <div class="settingInfo">
                        <p class="settingTitle">Delete Account</p>
                        <p class="settingDesc">This action cannot be undone</p>
                    </div>
                    <button type="button" class="settingBtn deleteAccountBtn" id="deleteAccountBtn" onclick="deleteAccount()">Delete</button>
                </div>
            </div>
           </div>

        <div class="registrationDetails notificationSettings">
            <div class="profile123">
                <p class="profileDesc"> Notification Settings</p>
                    <i class="material-icons profileIcon" style="color:rgb(66, 133, 244);">notifications</i>
            </div>
            <div class="notificationContainer">
                <div class="notificationItem">
                    <div class="notificationInfo">
                        <p class="notificationTitle">Email Notifications</p>
                        <p class="notificationDesc">Receive notifications via email</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="emailNotif" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="notificationItem">
                    <div class="notificationInfo">
                        <p class="notificationTitle">Complaint Updates</p>
                        <p class="notificationDesc">Updates on complaint status</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="complaintNotif" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
           </div>

    </div>
</div>
<script>
    fetch('../backend/getuser.php')
            .then(response => response.json())
            .then(data => {
                if (data.fullName) {
                    document.querySelector('.username').textContent = data.fullName;
                }
            })
            .catch(error => console.error('Error loading user info:', error));

    function deleteAccount() {
        if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
            fetch('../backend/deleteaccount.php', {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = 'login.html';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting account.');
            });
        }
    }
</script>
<script src="languageToggle/settingsLanguageToggle.js"></script>

<script>
    // Notifications logic (mirrors dashboard)
    (function(){
        const currentLanguage = localStorage.getItem('currentLanguage') || 'en';

        function getTimeAgo(date){
            const seconds = Math.floor((new Date() - date)/1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds/60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds/3600) + 'h ago';
            return Math.floor(seconds/86400) + 'd ago';
        }

        function setLocalizedTexts(){
            const ne = currentLanguage === 'ne';
            const header = document.getElementById('notification-header-text');
            const btn = document.getElementById('mark-all-read-btn');
            if (header) header.textContent = ne ? 'सूचनाहरू' : 'Notifications';
            if (btn) btn.textContent = ne ? 'सबै पढिएको रूपमा चिह्नित गर्नुहोस्' : 'Mark all as read';
        }

        function loadNotifications(){
            fetch('../backend/getnotifications.php', { credentials: 'include' })
                .then(r=>r.json())
                .then(data=>{
                    if (!data || !data.success) return;
                    const list = document.getElementById('notification-list');
                    const badge = document.getElementById('notification-badge');
                    const unread = data.unread_count || 0;
                    if (badge) {
                        if (unread > 0){ badge.style.display = 'flex'; badge.textContent = unread > 9 ? '9+' : unread; }
                        else { badge.style.display = 'none'; }
                    }
                    if (list){
                        if (!data.notifications || data.notifications.length === 0){
                            list.innerHTML = `<div class="notification-empty">${(currentLanguage==='ne')?'अहिले कुनै सूचना छैन':'No notifications yet'}</div>`;
                        } else {
                            list.innerHTML = data.notifications.map(n => {
                                const t = getTimeAgo(new Date(n.created_at));
                                const unreadClass = (n.is_read === 0 || n.is_read === false) ? 'unread' : '';
                                return `<div class="notification-item ${unreadClass}" data-id="${n.notification_id}">
                                            <div class="notification-item-message">${n.message}</div>
                                            <div class="notification-item-time">${t}</div>
                                        </div>`;
                            }).join('');
                        }
                    }
                })
                .catch(console.error);
        }

        function markNotificationAsRead(id){
            const fd = new FormData();
            fd.append('notification_id', id);
            fetch('../backend/marknotificationsread.php', { method:'POST', body: fd, credentials:'include' })
                .then(r=>r.json()).then(()=>loadNotifications()).catch(console.error);
        }

        function markAllNotificationsRead(){
            fetch('../backend/marknotificationsread.php', { method:'POST', credentials:'include' })
                .then(r=>r.json()).then(()=>loadNotifications()).catch(console.error);
        }

        function toggleNotificationDropdown(){
            const dd = document.getElementById('notification-dropdown');
            dd.classList.toggle('show');
            if (dd.classList.contains('show')) loadNotifications();
        }

    }
</script>

</body>
</html>
