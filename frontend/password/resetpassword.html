<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Government Complaint Portal</title>
    <link rel="stylesheet" href="../style/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" type="img/png" href="../images/logo.png">
    <script src="../languageToggle/authLanguageToggle.js"></script>
</head>
<body class="change-password-body">
    <div class="fp-wrapper">
        <form class="fp-form" id="resetPasswordForm">
            <div style="background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center;">
                <p id="sentToLabel" style="margin: 0; font-size: 12px; color: #666;">Verification code sent to:</p>
                <p style="margin: 5px 0 0 0; font-weight: bold; color: #333;" id="emailDisplay"></p>
            </div>
            <div>
                <label class="fp-label" for="verificationCode">Verification Code</label>
                <input class="fp-input" type="text" id="verificationCode" name="verificationCode" placeholder="Enter 6-digit code" required maxlength="6">
            </div>
            <div>
                <label class="fp-label" for="newPassword">New Password</label>
                <input class="fp-input" type="password" id="newPassword" name="newPassword" placeholder="Enter new password" required>
            </div>
            <div>
                <label class="fp-label" for="confirmPassword">Confirm Password</label>
                <input class="fp-input" type="password" id="confirmPassword" name="confirmPassword" placeholder="Re-enter new password" required>
            </div>
            <button class="fp-btn" id="updatePasswordBtn" type="submit">Update Password</button>
            <div style="text-align: center; margin-top: 15px;">
                <a href="../login.html" class="back-to-login" style="color: #1558df; text-decoration: none;">Back to Login</a>
            </div>
        </form>
    </div>

    <script>
        // Check if email is stored in session
        const email = sessionStorage.getItem('resetEmail');
        if (!email) {
            alert('Please start from the forgot password page');
            window.location.href = 'forgetpassword.html';
        } else {
            // Display the email on the page
            document.getElementById('emailDisplay').textContent = email;
        }

        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const verificationCode = document.getElementById('verificationCode').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            try {
                const response = await fetch('../../backend/resetpassword.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'email=' + encodeURIComponent(email) + 
                          '&verificationCode=' + encodeURIComponent(verificationCode) +
                          '&newPassword=' + encodeURIComponent(newPassword)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Password updated successfully!');
                    // Clear session storage
                    sessionStorage.removeItem('resetEmail');
                    window.location.href = '../login.html';
                } else {
                    alert(result.message || 'Error updating password');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    </script>
</body>
</html>
